# - C I R C L E C I   C O N T I N U O U S   I N T E G R A T I O N
# Download, compile, test and deploy to the production server at Heroku.
# CircleCI has the ability to deploy to Heroku and integrate more than one
#   project on the same pipeline.
# 
# Rules:
# 1. Try to keep the front end and the back end aligned. So event they seem to be two different applications I can reduce
#    exceptions if I drop both on staging even if there are no changes on one or both of the applications. The stage
#    branch that triggers Heroku installation id "test".
# 2. There is no possibility to run docker containers. So I have to create an special configuration to start in parallel
#    the ApiSimulator on the frontend and the application for acceptance on the backend. Get back the manual start and
#    stop for the ApiSimulator and include the code on the Heroku repository only.
# 3. Test deployment go to the **stage** instances. To deploy tests we should be sure that all test checks have been passed
#    or we can deploy changes that go to stage without passing unit testing or acceptance testing. So test should do all
#    previous stages until some sort of optimization is found.
# 4. Until script adjustment acceptance is optional to allow a commit to pass stage.
version: 2.1
# orbs:
#   # "cypress-io/cypress@1" installs the latest published
#   # version "1.x.y" of the orb. We recommend you then use
#   # the strict explicit version "cypress-io/cypress@1.x.y"
#   # to lock the version and prevent unexpected CI changes
#   cypress: cypress-io/cypress@1
jobs:
  start-job:
    docker:
      - image: circleci/node:12.16.3-browsers
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - run:
          name: PROJECT - Check node version
          command: |
            node -v
      - run:
          name: CHECK - Verify if we have java along node
          working_directory: Printer3D-frontend
          command: |
            java -version
            npm install
            npm run test:prod
      # - run:
      #     name: CHECK - Start the backend api simulator
      #     working_directory: Printer3D-frontend
      #     command: |
      #       npm install
      #       npm run start:simulator
      #       npm run stop:simulator
     
  create-frontend-environment-job:
    docker:
      - image: circleci/node:12.16.3-browsers
    steps:
      - run:
          name: Start-Frontend Environment Validation
          command: |
            node -v
      - checkout
      - run:
          name: Validate node version in use and install
          working_directory: Printer3D-frontend
          command: |
            echo '>> Printer3D - frontend: Validate environment version and store cache'
            node -v
            npm install
      - save_cache:
          paths:
            - ~/project/Printer3D-frontend/node_modules
          key: printer3d-frontend-{{ checksum "~/project/Printer3D-frontend/package.json" }}
  create-backend-environment-job:
    docker:
      - image: circleci/openjdk:11.0.1-jdk
    steps:
      - checkout
      - run:
          name: Start-Backend Environment Validation
          environment:
            _JAVA_OPTIONS: "-Xmx3g"
            GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
          command: |
            ~/project/Printer3D-backend/gradlew -version
      - run:
          name: BACKEND - Build SpringBoot code
          working_directory: Printer3D-backend
          command: |
            ./gradlew clean dependencies
      - save_cache:
          paths:
            - ~/project/Printer3D-backend/.gradle
          key: printer3d-backend-{{ checksum "~/project/Printer3D-backend/gradle/wrapper/gradle-wrapper.properties" }}
  build-frontend-job:
    docker:
      - image: circleci/node:12.16.3-browsers
    environment:
      # Customize the environment values to use on the jobs
      PORT: 5100
    steps:
      - checkout
      - restore_cache:
          key: printer3d-frontend-{{ checksum "~/project/Printer3D-frontend/package.json" }}
      - run:
          name: FRONTEND - Install the framework
          working_directory: Printer3D-frontend
          command: |
            node -v
            npm install
      - run:
          name: FRONTEND - Build production deployment code
          working_directory: Printer3D-frontend
          command: |
            npm run build:prod
      - save_cache:
          paths:
            - ~/project/Printer3D-frontend/node_modules
          key: printer3d-frontend-{{ checksum "~/project/Printer3D-frontend/package.json" }}
      - save_cache:
          paths:
            - ~/project/Printer3D-frontend/deploy
          key: printer3d-frontend-deploy
  acceptance-frontend-job:
    docker:
      - image: circleci/node:12.16.3-browsers
    environment:
      # Customize the environment values to use on the jobs
      PORT: 5100
      CYPRESS_KEY: 9eebb605-a163-4da0-bb36-6af73faddf1b
    steps:
      - checkout
      - run:
          name: FRONTEND - Install the framework
          working_directory: Printer3D-frontend
          command: |
            node -v
            npm install
      - run:
          name: FRONTEND - Start backend simulator & run tests
          working_directory: Printer3D-frontend
          command: |
            npm run build:prod
            npm run acceptance:simulator
            npm run acceptance:cypress
  
  build-backend-job:
    docker:
      - image: circleci/openjdk:11-jdk
    steps:
      - checkout
      - restore_cache:
          key: printer3d-backend-{{ checksum "~/project/Printer3D-backend/gradle/wrapper/gradle-wrapper.properties" }}
      - run:
          name: BACKEND - Build SpringBoot code
          working_directory: Printer3D-backend
          command: |
            ./gradlew clean bootJar
      - save_cache:
          paths: 
            - ~/project/Printer3D-backend/.gradle
          key: printer3d-backend-{{ checksum "~/project/Printer3D-backend/gradle/wrapper/gradle-wrapper.properties" }}
      - store_artifacts:
          path: ~/project/Printer3D-backend/build/libs
  test-backend-job:
    docker:
      - image: circleci/openjdk:11-jdk
        environment:
          _JAVA_OPTIONS: "-Xmx3g"
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
      - image: circleci/postgres:11.1
        environment:
          POSTGRES_USER: inno-user
          POSTGRES_DB: inno-password
    environment:
      PORT: 9500
    steps:
      - checkout
      - restore_cache:
          key: printer3d-backend-{{ checksum "~/project/Printer3D-backend/gradle/wrapper/gradle-wrapper.properties" }}
      - run:
          name: BACKEND - Start the application in local profile
          working_directory: Printer3D-backend
          environment:
            SPRING_PROFILES_ACTIVE: local
            PORT: 9500
            JDBC_DATABASE_URL: "jdbc:postgresql://0.0.0.0:5432/postgres"
            DB_USER: inno-user
            DB_PASSWORD: inno-password
          command: |
            ./gradlew bootRun
      - run:
          name: BACKEND - Unit Testing application
          working_directory: Printer3D-backend
          command: |
            ./gradlew test

  frontend-stage-to-heroku:
  # This job requires to change the code that is deployed to Heroku so the installation-build-run steps on that
  #   environment will work without eceptions.
    docker:
      - image: circleci/node:12.16.3-browsers
        environment:
          HEROKU_APP_NAME: printer3d-frontend-stage
          HEROKU_API_KEY: 0898c4c7-7389-4023-940b-ba5d7d799f73
    steps:
      - checkout
      # Restore the node_modules installation. Optimization will include the precompiled packages.
      - restore_cache:
          key: printer3d-frontend-{{ checksum "~/project/Printer3D-frontend/package.json" }}
      - run:
          name: FRONTEND - Show the current node configuration
          working_directory: Printer3D-frontend
          command: |
            node -v
      - run:
          name: FRONTEND - Remove cypress dependent package
          working_directory: Printer3D-frontend
          command: |
            sed -i '/bahmutov.add/d' package.json
      - run:
          name: FRONTEND - Install node packages
          working_directory: Printer3D-frontend
          command: |
            npm install
      - run:
          name: FRONTEND - Build deployment code
          working_directory: Printer3D-frontend
          command: |
            npm run build:prod
      - run:
          name: FRONTEND - Clone Heroku repository
          working_directory: Printer3D-frontend
          command: |
            git config --global user.email "adamantinoo.git@gmail.com"
            git config --global user.name "Adam antinoo"
            git init
            rm -rf .gitignore
            git add *.*
            git add config
            git add src
            git add dist
            git commit -m "-[HEROKU] Commiting code for deployment"
      - run:
          name: Deploy Master to Heroku
          working_directory: Printer3D-frontend
          command: |
            git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git master --force
  backend-stage-to-heroku:
    docker:
      - image: circleci/openjdk:11-jdk
        environment:
          _JAVA_OPTIONS: "-Xmx3g"
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
          HEROKU_APP_NAME: printer3d-backend-stage
          HEROKU_API_KEY: 0898c4c7-7389-4023-940b-ba5d7d799f73
    steps:
      - checkout
      - run:
          name: BACKEND - Update commit code
          working_directory: Printer3D-backend
          command: |
            git config --global user.email "adamantinoo.git@gmail.com"
            git config --global user.name "Adam antinoo"
            git init
            git add .gitignore
            git add *.*
            git add src
            git add gradle
            git add gradlew
            git commit -m "-[HEROKU] Commiting code for deployment"
      - run:
          name: BACKEND - Deploy Master to Heroku
          working_directory: Printer3D-backend
          command: |
            git push https://heroku:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git master --force

  backend-prod-to-heroku:
    docker:
      - image: circleci/node:12.16.3-browsers
    steps:
      - run:
          name: FRONTEND - Validate node version
          command: |
            node -v

workflows:
  version: 2
  printer3d-deploy:
    jobs:
      - start-job:
          filters:
            branches:
              only:
                - experimental
                - development
                - test
                - test-frontend
                - test-backend
                - master
      - create-frontend-environment-job:
          requires:
            - start-job
          filters:
            branches:
              only:
                - master
      - create-backend-environment-job:
          requires:
            - start-job
          filters:
            branches:
              only:
                - master
      - build-frontend-job:
          requires:
            - start-job
          filters:
            branches:
              only:
                - development
      - build-backend-job:
          requires:
            - start-job
          filters:
            branches:
              only:
                - development
      - acceptance-frontend-job:
          requires:
            - start-job
          filters:
            branches:
              only:
                - development
                - test
      - backend-stage-to-heroku:
          requires:
            - start-job
          filters:
            branches:
              only:
                - test
      - frontend-stage-to-heroku:
        # This isolation from acceptance tests is provisional
          requires:
             - start-job
          filters:
            branches:
              only:
                - test
